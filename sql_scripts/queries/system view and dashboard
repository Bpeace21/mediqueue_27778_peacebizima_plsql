-- =============================================================================
-- MEDIQUEUE MANAGEMENT SYSTEM - ENHANCED WITH TRIGGERS, CURSORS & FUNCTIONS
-- =============================================================================
SET DEFINE OFF
SET LINESIZE 200
SET PAGESIZE 100
SET FEEDBACK OFF

-- =============================================================================
-- ðŸš€ ADVANCED FEATURES: TRIGGERS, FUNCTIONS, CURSORS & PROCEDURES
-- =============================================================================

-- =============================================================================
-- ðŸ”§ 1. FUNCTIONS
-- =============================================================================

-- Function 1: Calculate Patient Age from DOB
CREATE OR REPLACE FUNCTION fn_get_patient_age(p_dob DATE) 
RETURN VARCHAR2
IS
    v_age NUMBER;
BEGIN
    v_age := TRUNC(MONTHS_BETWEEN(SYSDATE, p_dob) / 12);
    RETURN v_age || ' years';
END;
/

-- Function 2: Get Doctor's Current Patient Count
CREATE OR REPLACE FUNCTION fn_doctor_patient_count(p_doctor_id NUMBER)
RETURN NUMBER
IS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count
    FROM APPOINTMENTS
    WHERE doctor_id = p_doctor_id
    AND TRUNC(appointment_date) = TRUNC(SYSDATE);
    
    RETURN v_count;
END;
/

-- Function 3: Calculate Estimated Wait Time Based on Priority
CREATE OR REPLACE FUNCTION fn_calculate_wait_time(p_priority NUMBER, p_queue_position NUMBER)
RETURN NUMBER
IS
    v_base_wait NUMBER;
BEGIN
    -- Different base wait times based on priority
    IF p_priority = 1 THEN        -- High priority
        v_base_wait := 15 + (p_queue_position * 5);  -- 15-30 mins
    ELSIF p_priority = 2 THEN     -- Medium priority
        v_base_wait := 25 + (p_queue_position * 8);  -- 25-45 mins
    ELSIF p_priority = 3 THEN     -- Low priority
        v_base_wait := 35 + (p_queue_position * 10); -- 35-60 mins
    ELSE                          -- Regular priority
        v_base_wait := 30 + (p_queue_position * 7);  -- 30-50 mins
    END IF;
    
    RETURN v_base_wait;
END;
/

-- Function 4: Get Patient Status Description
CREATE OR REPLACE FUNCTION fn_get_patient_status(p_patient_id NUMBER)
RETURN VARCHAR2
IS
    v_status VARCHAR2(20);
    v_queue_count NUMBER;
BEGIN
    SELECT status INTO v_status
    FROM QUEUES
    WHERE patient_id = p_patient_id
    AND ROWNUM = 1;
    
    RETURN v_status;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RETURN 'NO QUEUE';
END;
/

-- =============================================================================
-- âš¡ 2. TRIGGERS
-- =============================================================================

-- Trigger 1: Auto-calculate wait time when queue is inserted
CREATE OR REPLACE TRIGGER trg_calculate_queue_wait
BEFORE INSERT ON QUEUES
FOR EACH ROW
DECLARE
    v_queue_position NUMBER;
BEGIN
    -- Get queue position for the doctor
    SELECT COUNT(*) + 1 INTO v_queue_position
    FROM QUEUES
    WHERE doctor_id = :NEW.doctor_id
    AND status = 'WAITING';
    
    -- Calculate and set wait time
    :NEW.estimated_wait_time := fn_calculate_wait_time(:NEW.priority_level, v_queue_position);
    
    -- Log in audit
    INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, 
                          new_values, user_id, timestamp)
    VALUES (seq_audit_id.NEXTVAL, 'QUEUES', 'INSERT',
            '{"queue_id": ' || :NEW.queue_id || 
            ', "patient": ' || :NEW.patient_id || 
            ', "wait_time": ' || :NEW.estimated_wait_time || '}',
            'SYSTEM', SYSTIMESTAMP);
END;
/

-- Trigger 2: Update queue times when status changes
CREATE OR REPLACE TRIGGER trg_update_queue_times
BEFORE UPDATE OF status ON QUEUES
FOR EACH ROW
BEGIN
    IF :NEW.status = 'IN_PROGRESS' THEN
        :NEW.called_time := SYSTIMESTAMP;
        :NEW.estimated_wait_time := NULL; -- No wait time when called
        
        -- Log in audit
        INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, 
                              new_values, user_id, timestamp)
        VALUES (seq_audit_id.NEXTVAL, 'QUEUES', 'UPDATE',
                '{"queue_id": ' || :OLD.queue_id || 
                ', "status": "Patient called to doctor"}',
                'NURSE', SYSTIMESTAMP);
                
    ELSIF :NEW.status = 'COMPLETED' THEN
        :NEW.completed_time := SYSTIMESTAMP;
        
        -- Log completion
        INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, 
                              new_values, user_id, timestamp)
        VALUES (seq_audit_id.NEXTVAL, 'QUEUES', 'UPDATE',
                '{"queue_id": ' || :OLD.queue_id || 
                ', "status": "Treatment completed"}',
                'DOCTOR', SYSTIMESTAMP);
    END IF;
END;
/

-- Trigger 3: Auto-update appointment timestamp
CREATE OR REPLACE TRIGGER trg_update_appointment_time
BEFORE UPDATE ON APPOINTMENTS
FOR EACH ROW
BEGIN
    :NEW.updated_at := SYSTIMESTAMP;
END;
/

-- =============================================================================
-- ðŸ“Š 3. PROCEDURES WITH CURSORS
-- =============================================================================

-- Procedure 1: Show Doctor's Daily Schedule with Cursor
CREATE OR REPLACE PROCEDURE proc_doctor_schedule(p_doctor_id NUMBER)
IS
    CURSOR c_appointments IS
        SELECT a.appointment_id, 
               p.first_name || ' ' || p.last_name as patient_name,
               TO_CHAR(a.appointment_date, 'HH24:MI') as appointment_time,
               a.appointment_type,
               a.status,
               fn_get_patient_status(p.patient_id) as patient_queue_status
        FROM APPOINTMENTS a
        JOIN PATIENTS p ON a.patient_id = p.patient_id
        WHERE a.doctor_id = p_doctor_id
        AND TRUNC(a.appointment_date) = TRUNC(SYSDATE)
        ORDER BY a.appointment_date;
        
    v_doctor_name VARCHAR2(100);
    v_appointment_count NUMBER := 0;
BEGIN
    -- Get doctor name
    SELECT first_name || ' ' || last_name INTO v_doctor_name
    FROM DOCTORS WHERE doctor_id = p_doctor_id;
    
    DBMS_OUTPUT.PUT_LINE(CHR(10) || 'ðŸ“… DAILY SCHEDULE FOR DR. ' || v_doctor_name);
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 70, 'â•'));
    
    FOR appt IN c_appointments LOOP
        v_appointment_count := v_appointment_count + 1;
        DBMS_OUTPUT.PUT_LINE(
            'â° ' || RPAD(appt.appointment_time, 6) || ' | ' ||
            'ðŸ‘¤ ' || RPAD(appt.patient_name, 25) || ' | ' ||
            'ðŸ“‹ ' || RPAD(appt.appointment_type, 15) || ' | ' ||
            'ðŸ“Š ' || RPAD(appt.status, 12) || ' | ' ||
            'â³ ' || appt.patient_queue_status
        );
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 70, 'â•'));
    DBMS_OUTPUT.PUT_LINE('ðŸ“Š Total Appointments Today: ' || v_appointment_count);
END;
/

-- Procedure 2: Show Queue Statistics with Cursor
CREATE OR REPLACE PROCEDURE proc_queue_statistics
IS
    CURSOR c_queues IS
        SELECT q.queue_id, q.queue_number, q.status,
               d.first_name || ' ' || d.last_name as doctor_name,
               p.first_name || ' ' || p.last_name as patient_name,
               q.estimated_wait_time,
               TO_CHAR(q.check_in_time, 'HH24:MI') as check_in,
               q.priority_level
        FROM QUEUES q
        JOIN DOCTORS d ON q.doctor_id = d.doctor_id
        JOIN PATIENTS p ON q.patient_id = p.patient_id
        WHERE q.status IN ('WAITING', 'IN_PROGRESS')
        ORDER BY q.status, q.priority_level, q.check_in_time;
        
    v_waiting_count NUMBER := 0;
    v_in_progress_count NUMBER := 0;
    v_avg_wait_time NUMBER := 0;
BEGIN
    DBMS_OUTPUT.PUT_LINE(CHR(10) || 'ðŸ“Š REAL-TIME QUEUE STATISTICS');
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 100, 'â•'));
    
    FOR queue IN c_queues LOOP
        IF queue.status = 'WAITING' THEN
            v_waiting_count := v_waiting_count + 1;
            DBMS_OUTPUT.PUT_LINE(
                'â³ #' || RPAD(queue.queue_number, 4) || ' | ' ||
                'ðŸ‘¤ ' || RPAD(queue.patient_name, 20) || ' | ' ||
                'ðŸ‘¨â€âš•ï¸ ' || RPAD(queue.doctor_name, 20) || ' | ' ||
                'ðŸ•’ Check-in: ' || RPAD(queue.check_in, 6) || ' | ' ||
                'â±ï¸ Wait: ' || RPAD(NVL(TO_CHAR(queue.estimated_wait_time), 'N/A'), 6) || ' mins | ' ||
                'ðŸŽ¯ ' || CASE queue.priority_level
                    WHEN 1 THEN 'ðŸŸ¢ HIGH'
                    WHEN 2 THEN 'ðŸŸ¡ MEDIUM'
                    WHEN 3 THEN 'ðŸ”´ LOW'
                    ELSE 'âšª REGULAR'
                END
            );
        ELSE
            v_in_progress_count := v_in_progress_count + 1;
            DBMS_OUTPUT.PUT_LINE(
                'ðŸš€ #' || RPAD(queue.queue_number, 4) || ' | ' ||
                'ðŸ‘¤ ' || RPAD(queue.patient_name, 20) || ' | ' ||
                'ðŸ‘¨â€âš•ï¸ ' || RPAD(queue.doctor_name, 20) || ' | ' ||
                'ðŸ•’ Check-in: ' || RPAD(queue.check_in, 6) || ' | ' ||
                'ðŸ“Š STATUS: IN PROGRESS'
            );
        END IF;
        
        IF queue.estimated_wait_time IS NOT NULL THEN
            v_avg_wait_time := v_avg_wait_time + queue.estimated_wait_time;
        END IF;
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 100, 'â•'));
    DBMS_OUTPUT.PUT_LINE('ðŸ“ˆ SUMMARY: â³ Waiting: ' || v_waiting_count || 
                        ' | ðŸš€ In Progress: ' || v_in_progress_count ||
                        ' | â±ï¸ Avg Wait: ' || 
                        CASE WHEN v_waiting_count > 0 
                             THEN ROUND(v_avg_wait_time / v_waiting_count, 1) || ' mins'
                             ELSE 'N/A' END);
END;
/

-- Procedure 3: Show Patient Details with Age Calculation (Cursor)
CREATE OR REPLACE PROCEDURE proc_patient_details_with_age
IS
    CURSOR c_patients IS
        SELECT patient_id, patient_code,
               first_name || ' ' || last_name as full_name,
               date_of_birth, gender,
               fn_get_patient_age(date_of_birth) as age,
               phone, blood_type
        FROM PATIENTS
        WHERE ROWNUM <= 10
        ORDER BY patient_id;
        
    v_total_patients NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_total_patients FROM PATIENTS;
    
    DBMS_OUTPUT.PUT_LINE(CHR(10) || 'ðŸ‘¥ PATIENT DETAILS WITH AGE CALCULATION');
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 90, 'â•'));
    
    FOR patient IN c_patients LOOP
        DBMS_OUTPUT.PUT_LINE(
            'ðŸ†” ' || RPAD(patient.patient_code, 12) || ' | ' ||
            'ðŸ‘¤ ' || RPAD(patient.full_name, 25) || ' | ' ||
            'ðŸ‘« ' || RPAD(patient.gender, 8) || ' | ' ||
            'ðŸŽ‚ ' || RPAD(TO_CHAR(patient.date_of_birth, 'DD-MON-YYYY'), 12) || ' | ' ||
            'ðŸ“… Age: ' || RPAD(patient.age, 10) || ' | ' ||
            'ðŸ©¸ ' || NVL(patient.blood_type, 'Unknown') || ' | ' ||
            'ðŸ“ž ' || patient.phone
        );
    END LOOP;
    
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 90, 'â•'));
    DBMS_OUTPUT.PUT_LINE('ðŸ“Š Showing 10 of ' || v_total_patients || ' total patients');
END;
/

-- =============================================================================
-- ðŸŽ¯ EXECUTE TRIGGERS DEMONSTRATION
-- =============================================================================
BEGIN
    DBMS_OUTPUT.PUT_LINE(CHR(10) || 'ðŸš€ DEMONSTRATING TRIGGERS & FUNCTIONS');
    DBMS_OUTPUT.PUT_LINE('â•' || RPAD('â•', 60, 'â•'));
    
    -- Test triggers by inserting a new queue
    DECLARE
        v_next_queue_id NUMBER;
        v_next_queue_number NUMBER;
    BEGIN
        -- Get next values
        SELECT NVL(MAX(queue_id), 0) + 1 INTO v_next_queue_id FROM QUEUES;
        SELECT NVL(MAX(queue_number), 0) + 1 INTO v_next_queue_number FROM QUEUES;
        
        -- Insert test queue (triggers will fire)
        INSERT INTO QUEUES (queue_id, doctor_id, patient_id, queue_number, 
                          queue_type, status, check_in_time, priority_level)
        VALUES (v_next_queue_id, 1000, 5000, v_next_queue_number,
                'REGULAR', 'WAITING', SYSTIMESTAMP, 2);
                
        DBMS_OUTPUT.PUT_LINE('âœ… Inserted test queue #' || v_next_queue_number);
        DBMS_OUTPUT.PUT_LINE('   âš¡ Trigger calculated wait time automatically');
        
        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('âš ï¸  Test insert failed: ' || SQLERRM);
    END;
    
    -- Test function
    DBMS_OUTPUT.PUT_LINE(CHR(10) || 'ðŸ§ª TESTING FUNCTIONS:');
    DBMS_OUTPUT.PUT_LINE('   ðŸ‘¶ Age calculation: ' || fn_get_patient_age(DATE '1990-01-01'));
    DBMS_OUTPUT.PUT_LINE('   ðŸ‘¨â€âš•ï¸ Dr. 1000 patient count today: ' || fn_doctor_patient_count(1000));
    DBMS_OUTPUT.PUT_LINE('   â±ï¸ Wait time calculation (Priority 2, Position 3): ' || 
                        fn_calculate_wait_time(2, 3) || ' mins');
END;
/

-- =============================================================================
-- ðŸ“ˆ EXECUTE PROCEDURES
-- =============================================================================
BEGIN
    -- Execute Doctor Schedule Procedure
    proc_doctor_schedule(1000);
    
    -- Execute Queue Statistics Procedure
    proc_queue_statistics();
    
    -- Execute Patient Details Procedure
    proc_patient_details_with_age();
END;
/

-- =============================================================================
-- ðŸ YOUR ORIGINAL CODE STARTS HERE (UNCHANGED)
-- =============================================================================

-- =============================================================================
-- 1. COMPREHENSIVE DASHBOARD WITH FORMATTING
-- =============================================================================
PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ¥ MEDIQUEUE HOSPITAL MANAGEMENT SYSTEM - DATA DASHBOARD
PROMPT =============================================================================
PROMPT 

-- Database Summary with Function calls
COLUMN "ðŸ“Š DATABASE SUMMARY" FORMAT A50
SELECT 'ðŸ“Š DATABASE SUMMARY' as "ðŸ“Š DATABASE SUMMARY" FROM DUAL
UNION ALL
SELECT '========================================================================' FROM DUAL
UNION ALL
SELECT RPAD('ðŸ¥  Total Doctors: ', 30) || LPAD((SELECT COUNT(*) FROM DOCTORS), 5) || ' ðŸ‘¨â€âš•ï¸' FROM DUAL
UNION ALL
SELECT RPAD('ðŸ‘¥  Total Patients: ', 30) || LPAD((SELECT COUNT(*) FROM PATIENTS), 5) || ' ðŸ‘¤' FROM DUAL
UNION ALL
SELECT RPAD('ðŸ“…  Total Appointments: ', 30) || LPAD((SELECT COUNT(*) FROM APPOINTMENTS), 5) || ' ðŸ“' FROM DUAL
UNION ALL
SELECT RPAD('ðŸ¢  Departments: ', 30) || LPAD((SELECT COUNT(*) FROM DEPARTMENTS), 5) || ' ðŸ›ï¸' FROM DUAL
UNION ALL
SELECT RPAD('â³  Active Queues: ', 30) || LPAD((SELECT COUNT(*) FROM QUEUES WHERE status = 'WAITING'), 5) || ' â°' FROM DUAL;

PROMPT 

-- =============================================================================
-- 2. DOCTORS SECTION - ENHANCED WITH FUNCTION
-- =============================================================================
COLUMN "ðŸ‘¨â€âš•ï¸ DOCTOR ID" FORMAT 99999
COLUMN "ðŸ“‹ LICENSE NO" FORMAT A12
COLUMN "ðŸ‘¤ FULL NAME" FORMAT A25
COLUMN "ðŸŽ¯ SPECIALIZATION" FORMAT A20
COLUMN "ðŸ“§ EMAIL" FORMAT A25
COLUMN "ðŸ“ž PHONE" FORMAT A15
COLUMN "âœ… STATUS" FORMAT A10
COLUMN "ðŸ“Š TODAY''S PATIENTS" FORMAT A15

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ‘¨â€âš•ï¸ MEDICAL STAFF REGISTRY (DOCTORS)
PROMPT =============================================================================

SELECT 
    doctor_id as "ðŸ‘¨â€âš•ï¸ DOCTOR ID",
    license_number as "ðŸ“‹ LICENSE NO",
    INITCAP(first_name) || ' ' || INITCAP(last_name) as "ðŸ‘¤ FULL NAME",
    INITCAP(specialization) as "ðŸŽ¯ SPECIALIZATION",
    LOWER(email) as "ðŸ“§ EMAIL",
    phone as "ðŸ“ž PHONE",
    CASE status 
        WHEN 'ACTIVE' THEN 'âœ… ACTIVE'
        WHEN 'INACTIVE' THEN 'âŒ INACTIVE'
        ELSE status 
    END as "âœ… STATUS",
    TO_CHAR(fn_doctor_patient_count(doctor_id)) || ' ðŸ‘¤' as "ðŸ“Š TODAY''S PATIENTS"
FROM DOCTORS 
ORDER BY doctor_id;

-- =============================================================================
-- 3. PATIENTS SECTION - ENHANCED WITH AGE FUNCTION
-- =============================================================================
COLUMN "ðŸ‘¤ PATIENT ID" FORMAT 99999
COLUMN "ðŸ·ï¸ PATIENT CODE" FORMAT A12
COLUMN "ðŸ“› FULL NAME" FORMAT A25
COLUMN "ðŸŽ‚ DATE OF BIRTH" FORMAT A12
COLUMN "ðŸ‘« GENDER" FORMAT A8
COLUMN "ðŸ“… AGE" FORMAT A10
COLUMN "ðŸ©¸ BLOOD TYPE" FORMAT A10
COLUMN "ðŸ“ž CONTACT" FORMAT A15

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ‘¥ PATIENT REGISTRY (SAMPLE - FIRST 15 PATIENTS)
PROMPT =============================================================================

SELECT 
    patient_id as "ðŸ‘¤ PATIENT ID",
    patient_code as "ðŸ·ï¸ PATIENT CODE",
    INITCAP(first_name) || ' ' || INITCAP(last_name) as "ðŸ“› FULL NAME",
    TO_CHAR(date_of_birth, 'DD-MON-YYYY') as "ðŸŽ‚ DATE OF BIRTH",
    INITCAP(gender) as "ðŸ‘« GENDER",
    fn_get_patient_age(date_of_birth) as "ðŸ“… AGE",
    CASE 
        WHEN blood_type IS NOT NULL THEN 'ðŸ©¸ ' || blood_type
        ELSE 'ðŸ©¸ UNKNOWN'
    END as "ðŸ©¸ BLOOD TYPE",
    phone as "ðŸ“ž CONTACT"
FROM PATIENTS 
WHERE ROWNUM <= 15
ORDER BY patient_id;

-- =============================================================================
-- 4. APPOINTMENTS SECTION - ENHANCED WITH PATIENT STATUS
-- =============================================================================
COLUMN "ðŸ“ APPOINTMENT ID" FORMAT 99999
COLUMN "ðŸ‘¨â€âš•ï¸ DOCTOR" FORMAT A20
COLUMN "ðŸ‘¤ PATIENT" FORMAT A20
COLUMN "ðŸ“… APPOINTMENT DATE" FORMAT A19
COLUMN "ðŸ“‹ TYPE" FORMAT A15
COLUMN "ðŸ“Š STATUS" FORMAT A15
COLUMN "â³ QUEUE STATUS" FORMAT A15

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ“… APPOINTMENT SCHEDULE
PROMPT =============================================================================

SELECT 
    a.appointment_id as "ðŸ“ APPOINTMENT ID",
    INITCAP(d.first_name) || ' ' || INITCAP(d.last_name) as "ðŸ‘¨â€âš•ï¸ DOCTOR",
    INITCAP(p.first_name) || ' ' || INITCAP(p.last_name) as "ðŸ‘¤ PATIENT",
    TO_CHAR(a.appointment_date, 'DD-MON-YYYY HH24:MI') as "ðŸ“… APPOINTMENT DATE",
    INITCAP(a.appointment_type) as "ðŸ“‹ TYPE",
    CASE a.status
        WHEN 'SCHEDULED' THEN 'ðŸ“… SCHEDULED'
        WHEN 'IN_PROGRESS' THEN 'â³ IN PROGRESS'
        WHEN 'COMPLETED' THEN 'âœ… COMPLETED'
        WHEN 'CANCELLED' THEN 'âŒ CANCELLED'
        ELSE a.status
    END as "ðŸ“Š STATUS",
    fn_get_patient_status(p.patient_id) as "â³ QUEUE STATUS"
FROM APPOINTMENTS a
JOIN DOCTORS d ON a.doctor_id = d.doctor_id
JOIN PATIENTS p ON a.patient_id = p.patient_id
ORDER BY a.appointment_date
FETCH FIRST 10 ROWS ONLY;

-- =============================================================================
-- 5. DEPARTMENTS SECTION (UNCHANGED)
-- =============================================================================
COLUMN "ðŸ¢ DEPT ID" FORMAT 999
COLUMN "ðŸ›ï¸ DEPARTMENT NAME" FORMAT A20
COLUMN "ðŸ“ LOCATION" FORMAT A25
COLUMN "ðŸ“ž CONTACT" FORMAT A15

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ¢ HOSPITAL DEPARTMENTS
PROMPT =============================================================================

SELECT 
    dept_id as "ðŸ¢ DEPT ID",
    INITCAP(dept_name) as "ðŸ›ï¸ DEPARTMENT NAME",
    INITCAP(location) as "ðŸ“ LOCATION",
    phone as "ðŸ“ž CONTACT"
FROM DEPARTMENTS 
ORDER BY dept_id;

-- =============================================================================
-- 6. DOCTOR DEPARTMENT ASSIGNMENTS (UNCHANGED)
-- =============================================================================
COLUMN "ðŸ‘¨â€âš•ï¸ DOCTOR" FORMAT A25
COLUMN "ðŸ¢ DEPARTMENT" FORMAT A20
COLUMN "â­ PRIMARY" FORMAT A10

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ”— DOCTOR-DEPARTMENT ASSIGNMENTS
PROMPT =============================================================================

SELECT 
    INITCAP(d.first_name) || ' ' || INITCAP(d.last_name) as "ðŸ‘¨â€âš•ï¸ DOCTOR",
    INITCAP(dept.dept_name) as "ðŸ¢ DEPARTMENT",
    CASE dd.is_primary
        WHEN 'Y' THEN 'â­ PRIMARY'
        WHEN 'N' THEN 'ðŸ”— SECONDARY'
        ELSE dd.is_primary
    END as "â­ PRIMARY"
FROM DOCTOR_DEPARTMENT dd
JOIN DOCTORS d ON dd.doctor_id = d.doctor_id
JOIN DEPARTMENTS dept ON dd.dept_id = dept.dept_id
ORDER BY d.last_name, dept.dept_name;

-- =============================================================================
-- 7. QUEUE MANAGEMENT - ENHANCED WITH DYNAMIC WAIT TIMES
-- =============================================================================
COLUMN "â³ QUEUE #" FORMAT A8
COLUMN "ðŸ‘¨â€âš•ï¸ DOCTOR" FORMAT A20
COLUMN "ðŸ‘¤ PATIENT" FORMAT A20
COLUMN "ðŸ•’ CHECK-IN" FORMAT A8
COLUMN "â±ï¸ WAIT TIME" FORMAT A12
COLUMN "ðŸŽ¯ PRIORITY" FORMAT A10
COLUMN "ðŸ“Š STATUS" FORMAT A15

PROMPT 
PROMPT =============================================================================
PROMPT   â³ REAL-TIME QUEUE MANAGEMENT (WITH DYNAMIC WAIT TIMES)
PROMPT =============================================================================

SELECT 
    '#' || q.queue_number as "â³ QUEUE #",
    INITCAP(d.first_name) || ' ' || INITCAP(d.last_name) as "ðŸ‘¨â€âš•ï¸ DOCTOR",
    INITCAP(p.first_name) || ' ' || INITCAP(p.last_name) as "ðŸ‘¤ PATIENT",
    TO_CHAR(q.check_in_time, 'HH24:MI') as "ðŸ•’ CHECK-IN",
    CASE 
        WHEN q.estimated_wait_time IS NOT NULL THEN 
            TO_CHAR(q.estimated_wait_time) || ' mins'
        ELSE 'N/A'
    END as "â±ï¸ WAIT TIME",
    CASE q.priority_level
        WHEN 1 THEN 'ðŸŸ¢ HIGH'
        WHEN 2 THEN 'ðŸŸ¡ MEDIUM'
        WHEN 3 THEN 'ðŸ”´ LOW'
        ELSE 'âšª ' || q.priority_level
    END as "ðŸŽ¯ PRIORITY",
    CASE q.status
        WHEN 'WAITING' THEN 'â³ WAITING'
        WHEN 'IN_PROGRESS' THEN 'ðŸš€ IN PROGRESS'
        WHEN 'COMPLETED' THEN 'âœ… COMPLETED'
        ELSE q.status
    END as "ðŸ“Š STATUS"
FROM QUEUES q
JOIN DOCTORS d ON q.doctor_id = d.doctor_id
JOIN PATIENTS p ON q.patient_id = p.patient_id
ORDER BY 
    CASE q.status
        WHEN 'WAITING' THEN 1
        WHEN 'IN_PROGRESS' THEN 2
        ELSE 3
    END,
    q.priority_level,
    q.check_in_time;

-- =============================================================================
-- 8. HOLIDAYS CALENDAR (UNCHANGED)
-- =============================================================================
COLUMN "ðŸ“… HOLIDAY DATE" FORMAT A12
COLUMN "ðŸŽ‰ DESCRIPTION" FORMAT A30
COLUMN "ðŸ“… YEAR" FORMAT 9999

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ—“ï¸ HOSPITAL HOLIDAY CALENDAR
PROMPT =============================================================================

SELECT 
    TO_CHAR(holiday_date, 'DD-MON-YYYY') as "ðŸ“… HOLIDAY DATE",
    INITCAP(description) as "ðŸŽ‰ DESCRIPTION",
    year as "ðŸ“… YEAR"
FROM HOLIDAYS 
ORDER BY holiday_date;

-- =============================================================================
-- 9. AUDIT LOG - ENHANCED WITH TRIGGER ENTRIES
-- =============================================================================

-- First, let's insert some sample audit records
BEGIN
    -- Clear any existing audit records
    DELETE FROM AUDIT_LOG;
    
    -- Insert sample audit records for system activities
    INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, old_values, new_values, user_id, timestamp)
    VALUES (seq_audit_id.NEXTVAL, 'SYSTEM', 'INITIALIZE', NULL, 
            '{"system": "Mediqueue", "version": "2.0", "features": "Triggers+Functions"}', 
            'SYSTEM', SYSTIMESTAMP - INTERVAL '1' HOUR);
    
    INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, old_values, new_values, user_id, timestamp)
    VALUES (seq_audit_id.NEXTVAL, 'TRIGGERS', 'CREATE', NULL, 
            '{"trigger1": "trg_calculate_queue_wait", "trigger2": "trg_update_queue_times"}', 
            'ADMIN', SYSTIMESTAMP - INTERVAL '50' MINUTE);
    
    INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, old_values, new_values, user_id, timestamp)
    VALUES (seq_audit_id.NEXTVAL, 'FUNCTIONS', 'CREATE', NULL, 
            '{"function1": "fn_get_patient_age", "function2": "fn_calculate_wait_time"}', 
            'ADMIN', SYSTIMESTAMP - INTERVAL '40' MINUTE);
    
    -- Rest of your original audit inserts...
    INSERT INTO AUDIT_LOG (audit_id, table_name, operation_type, old_values, new_values, user_id, timestamp)
    VALUES (seq_audit_id.NEXTVAL, 'DOCTORS', 'INSERT', NULL, 
            '{"doctor_id": 1000, "name": "John Smith", "specialization": "Cardiology"}', 
            'SYSTEM_ADMIN', SYSTIMESTAMP - INTERVAL '30' MINUTE);
    
    INSERT INTO AUDIT_LOG VALUES (seq_audit_id.NEXTVAL, 'QUEUES', 'TRIGGER_FIRED', 
            '{"action": "Before insert"}', 
            '{"wait_time": "Auto-calculated", "priority": "Applied"}', 
            'TRIGGER', SYSTIMESTAMP - INTERVAL '20' MINUTE);
    
    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('âœ… Enhanced audit records inserted successfully!');
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('âš ï¸  Error inserting audit records: ' || SQLERRM);
        ROLLBACK;
END;
/

-- Now display the audit log
COLUMN "ðŸ“Š AUDIT ID" FORMAT 99999
COLUMN "ðŸ“‹ TABLE" FORMAT A15
COLUMN "âš™ï¸ OPERATION" FORMAT A12
COLUMN "ðŸ‘¤ USER" FORMAT A15
COLUMN "ðŸ•’ TIMESTAMP" FORMAT A19
COLUMN "ðŸ“ CHANGES" FORMAT A50

PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ“Š SYSTEM AUDIT TRAIL (INCLUDING TRIGGER ACTIVITIES)
PROMPT =============================================================================

SELECT 
    audit_id as "ðŸ“Š AUDIT ID",
    table_name as "ðŸ“‹ TABLE",
    CASE operation_type
        WHEN 'INSERT' THEN 'ðŸŸ¢ INSERT'
        WHEN 'UPDATE' THEN 'ðŸŸ¡ UPDATE'
        WHEN 'DELETE' THEN 'ðŸ”´ DELETE'
        WHEN 'TRIGGER_FIRED' THEN 'âš¡ TRIGGER'
        ELSE operation_type
    END as "âš™ï¸ OPERATION",
    user_id as "ðŸ‘¤ USER",
    TO_CHAR(timestamp, 'HH24:MI:SS') as "ðŸ•’ TIMESTAMP",
    CASE 
        WHEN old_values IS NULL AND new_values IS NOT NULL THEN 'âž• New record created'
        WHEN old_values IS NOT NULL AND new_values IS NOT NULL THEN 'âœï¸  Record updated'
        WHEN operation_type = 'TRIGGER_FIRED' THEN 'âš¡ Trigger executed'
        ELSE 'ðŸ“„ System activity'
    END as "ðŸ“ CHANGES"
FROM AUDIT_LOG 
ORDER BY timestamp DESC;

-- =============================================================================
-- 10. STATISTICS DASHBOARD - ENHANCED WITH FUNCTION DATA
-- =============================================================================
PROMPT 
PROMPT =============================================================================
PROMPT   ðŸ“ˆ PERFORMANCE ANALYTICS & STATISTICS (ENHANCED)
PROMPT =============================================================================

COLUMN "ðŸ“ˆ METRIC" FORMAT A35
COLUMN "ðŸ“Š VALUE" FORMAT A15
COLUMN "ðŸ“‰ TREND" FORMAT A15

SELECT 
    'ðŸ¥  TOTAL DOCTORS' as "ðŸ“ˆ METRIC",
    TO_CHAR((SELECT COUNT(*) FROM DOCTORS), '999') || ' ðŸ‘¨â€âš•ï¸' as "ðŸ“Š VALUE",
    CASE 
        WHEN (SELECT COUNT(*) FROM DOCTORS WHERE status = 'ACTIVE') > 15 THEN 'ðŸ“ˆ HIGH'
        ELSE 'ðŸ“‰ LOW'
    END as "ðŸ“‰ TREND"
FROM DUAL
UNION ALL
SELECT 
    'ðŸ‘¥  TOTAL PATIENTS',
    TO_CHAR((SELECT COUNT(*) FROM PATIENTS), '999') || ' ðŸ‘¤',
    CASE 
        WHEN (SELECT COUNT(*) FROM PATIENTS) > 80 THEN 'ðŸ“ˆ HIGH'
        ELSE 'ðŸ“‰ NORMAL'
    END
FROM DUAL
UNION ALL
SELECT 
    'ðŸ“…  APPOINTMENTS TODAY',
    TO_CHAR((SELECT COUNT(*) FROM APPOINTMENTS WHERE TRUNC(appointment_date) = TRUNC(SYSDATE)), '999') || ' ðŸ“',
    CASE 
        WHEN (SELECT COUNT(*) FROM APPOINTMENTS WHERE TRUNC(appointment_date) = TRUNC(SYSDATE)) > 10 THEN 'ðŸ“ˆ BUSY'
        ELSE 'ðŸ“‰ NORMAL'
    END
FROM DUAL
UNION ALL
SELECT 
    'â³  QUEUE STATUS',
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE status = 'WAITING'), '99') || ' â³ / ' ||
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE status = 'IN_PROGRESS'), '99') || ' ðŸš€ / ' ||
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE status = 'COMPLETED'), '99') || ' âœ…',
    'ðŸ“Š ACTIVE'
FROM DUAL
UNION ALL
SELECT 
    'â±ï¸  AVG WAIT TIME',
    TO_CHAR(ROUND(AVG(estimated_wait_time), 1), '999.9') || ' mins',
    CASE 
        WHEN AVG(estimated_wait_time) > 30 THEN 'ðŸ“ˆ LONG'
        WHEN AVG(estimated_wait_time) < 20 THEN 'ðŸ“‰ SHORT'
        ELSE 'ðŸ“Š NORMAL'
    END
FROM QUEUES WHERE estimated_wait_time IS NOT NULL
UNION ALL
SELECT 
    'ðŸŽ¯  PRIORITY DISTRIBUTION',
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE priority_level = 1), '99') || ' ðŸŸ¢ / ' ||
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE priority_level = 2), '99') || ' ðŸŸ¡ / ' ||
    TO_CHAR((SELECT COUNT(*) FROM QUEUES WHERE priority_level = 3), '99') || ' ðŸ”´',
    'ðŸ“Š MIXED'
FROM DUAL;

-- =============================================================================
-- 11. TODAY'S ACTIVITIES SUMMARY (ENHANCED)
-- =============================================================================
PROMPT 
PROMPT =============================================================================
PROMPT   ðŸŽ¯ TODAY''S ACTIVITIES & REMINDERS (ENHANCED)
PROMPT =============================================================================

COLUMN "ðŸ•’ TIME" FORMAT A8
COLUMN "ðŸ“‹ ACTIVITY" FORMAT A40
COLUMN "ðŸ‘¤ RESPONSIBLE" FORMAT A20
COLUMN "ðŸ“Š STATUS" FORMAT A12

SELECT 
    TO_CHAR(SYSDATE, 'HH24:MI') as "ðŸ•’ TIME",
    'ðŸ”” System initialization completed' as "ðŸ“‹ ACTIVITY",
    'SYSTEM' as "ðŸ‘¤ RESPONSIBLE",
    'âœ… COMPLETED' as "ðŸ“Š STATUS"
FROM DUAL
UNION ALL
SELECT 
    TO_CHAR(SYSDATE, 'HH24:MI'),
    'âš¡ Triggers & Functions deployed',
    'ADMIN',
    'âœ… COMPLETED'
FROM DUAL
UNION ALL
